# After successful privilege escalation, use this to list all obvious SSH keys stored under users' .ssh folder

#!/bin/bash                                                                                                                                                                                                                                                                                                                                                                                                                                                                               # Output report file                                                                                                                                                                                                                         REPORT_FILE="/home/l0042/non_protected_ssh_keys_report.txt"                                                                                                                                                                                                                                                                                                                                                                                                                               # Ensure the report file is empty                                                                                                                                                                                                            > "$REPORT_FILE"                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # Set permissions for the report file so that everyone can read it                                                                                                                                                                           chmod 644 "$REPORT_FILE"                                                                                                                                                                                                                                                                                                                                                                                                                                                                  # Function to check if a key is protected (encrypted)                                                                                                                                                                                        check_key_protection() {                                                                                                                                                                                                                         local key_file="$1"                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Check if the file contains a PUBLIC KEY header                                                                                                                                                                                             if grep -q "PUBLIC KEY" "$key_file"; then                                                                                                                                                                                                        return 1  # Not a private key, skip                                                                                                                                                                                                      fi                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Check if the file contains an ENCRYPTED header                                                                                                                                                                                             if grep -q "ENCRYPTED" "$key_file"; then                                                                                                                                                                                                         return 1  # Key is protected                                                                                                                                                                                                             else                                                                                                                                                                                                                                             return 0  # Key is not protected                                                                                                                                                                                                         fi                                                                                                                                                                                                                                       }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         # Iterate over each home directory in /home                                                                                                                                                                                                  for user_home in /home/*; do                                                                                                                                                                                                                     # Check if the entry is a directory                                                                                                                                                                                                          if [ -d "$user_home" ]; then                                                                                                                                                                                                                     user=$(basename "$user_home")                                                                                                                                                                                                                SSH_DIR="$user_home/.ssh"                                                                                                                                                                                                                                                                                                                                                                                                                                                                 # Check if the .ssh directory exists                                                                                                                                                                                                         if [ -d "$SSH_DIR" ]; then                                                                                                                                                                                                                       # Find all private keys in the .ssh directory                                                                                                                                                                                                for key_file in "$SSH_DIR"/*; do                                                                                                                                                                                                                 if [[ -f "$key_file" && "$key_file" =~ .*id_.* && ! "$key_file" =~ .*\.pub$ ]]; then                                                                                                                                                             check_key_protection "$key_file"                                                                                                                                                                                                             if [ $? -eq 0 ]; then                                                                                                                                                                                                                            # Key is not protected, append to the report                                                                                                                                                                                                 echo "User: $user, Key: $key_file" >> "$REPORT_FILE"                                                                                                                                                                                     fi                                                                                                                                                                                                                                       fi                                                                                                                                                                                                                                       done                                                                                                                                                                                                                                     fi                                                                                                                                                                                                                                       fi                                                                                                                                                                                                                                       done                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # If no non-protected keys were found, append a message to the report                                                                                                                                                                        if [ ! -s "$REPORT_FILE" ]; then                                                                                                                                                                                                                 echo "No non-protected SSH keys found." >> "$REPORT_FILE"                                                                                                                                                                                fi                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        exit 0#!/bin/bash

# Output report file
REPORT_FILE="/tmp/non_protected_ssh_keys_report.txt" 

# Ensure the report file is empty                                                                                                                                                                                                           

> "$REPORT_FILE"                                                                                                                                                                                                                                                                                                                                                                                                                                                                          

# Set permissions for the report file so that everyone can read it                                                                                                                                                                           
chmod 644 "$REPORT_FILE"                                                                                                                                                                                                                                                                                                                                                                                                                                                                  

# Function to check if a key is protected (encrypted)
check_key_protection() {
	local key_file="$1" 

	# Check if the file contains a PUBLIC KEY header
	if grep -q "PUBLIC KEY" "$key_file"; then
		return 1  # Not a private key, skip
	fi

	# Check if the file contains an ENCRYPTED header
	if grep -q "ENCRYPTED" "$key_file"; then
		return 1  # Key is protected
	else
		return 0  # Key is not protected
	fi
}

# Iterate over each home directory in /home
for user_home in /home/*; do
	# Check if the entry is a directory
	if [ -d "$user_home" ]; then
		user=$(basename "$user_home")
		SSH_DIR="$user_home/.ssh"
		
		# Check if the .ssh directory exists
		if [ -d "$SSH_DIR" ]; then
			# Find all private keys in the .ssh directory
			for key_file in "$SSH_DIR"/*; do
				if [[ -f "$key_file" && "$key_file" =~ .*id_.* && ! "$key_file" =~ .*\.pub$ ]]; then
					check_key_protection "$key_file"
					if [ $? -eq 0 ]; then
						# Key is not protected, append to the report
						echo "User: $user, Key: $key_file" >> "$REPORT_FILE"
					fi
				fi
			done
		fi
	fi
done

# If no non-protected keys were found, append a message to the report
if [ ! -s "$REPORT_FILE" ]; then
	echo "No non-protected SSH keys found." >> "$REPORT_FILE"
fi                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
exit 0
